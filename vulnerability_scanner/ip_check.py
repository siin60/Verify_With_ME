import cloudmersive_security_api_client
from cloudmersive_security_api_client.rest import ApiException as SecurityApiException
from .utils import retry_on_exception, text_file, security_configuration

@retry_on_exception(retries=3, delay=2)
def IP_Check(ip_address):  # Check IP address
    api_instance = cloudmersive_security_api_client.NetworkThreatDetectionApi(cloudmersive_security_api_client.ApiClient(security_configuration))
    try:
        # Check if IP address is a Bot client threat
        api_response_bot = api_instance.network_threat_detection_is_bot(ip_address)
        if api_response_bot.is_bot:
            text_file('The IP address is a bot client threat.')
            print('The IP address is a bot client threat.')
        else:
            text_file('The IP address is not a bot client threat.')
            print('The IP address is not a bot client threat.')

        # Check if IP address is a Tor server
        api_response_tor = api_instance.network_threat_detection_is_tor_node(ip_address)
        if api_response_tor.is_tor_node:
            text_file('The IP address is a Tor server.')
            print('The IP address is a Tor server.')
        else:
            text_file('The IP address is not a Tor server.')
            print('The IP address is not a Tor server.')

        # Check if IP address is a known threat
        api_response_threat = api_instance.network_threat_detection_is_threat(ip_address)
        if api_response_threat.is_threat:
            text_file('The IP address is a known threat.')
            print('The IP address is a known threat.')
        else:
            text_file('The IP address is not a known threat.')
            print('The IP address is not a known threat.')

    except SecurityApiException as e:
        if e.status == 401:
            text_file("Unauthorised request. Please check your API key.")
            print("Unauthorised request. Please check your API key.")
        elif e.status == 503 or e.status == 500:
            text_file("Internal Server Error. Please check the value format you entered and try again.")
            print("Internal Server Error. Please check the value format you entered and try again.")
        else:
            text_file(f"Exception when calling NetworkThreatDetectionApi: {e}")
            print("Exception when calling NetworkThreatDetectionApi: %s\n" % e)